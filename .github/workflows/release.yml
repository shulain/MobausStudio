# å…¬å¼€ä»“åº“æ„å»º Release
# æ­¤æ–‡ä»¶éœ€è¦æ”¾åˆ°å…¬å¼€ä»“åº“çš„ .github/workflows/ ç›®å½•
#
# è§¦å‘æ–¹å¼ï¼šç”±ç§æœ‰ä»“åº“é€šè¿‡ repository_dispatch è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
#
# å®‰å…¨è¯´æ˜ï¼š
# - ä»£ç é€šè¿‡ PAT ä»ç§æœ‰ä»“åº“ä¸´æ—¶æ‹‰å–ï¼Œåªå­˜åœ¨äºæ„å»ºç¯å¢ƒ
# - æ„å»ºå®Œæˆå runner é”€æ¯ï¼Œä»£ç ä¸ä¼šä¿ç•™åœ¨å…¬å¼€ä»“åº“
# - æ—¥å¿—å·²åšé™é»˜å¤„ç†ï¼Œå‡å°‘æ•æ„Ÿä¿¡æ¯æ³„éœ²
# - ç§æœ‰ä»“åº“åé€šè¿‡ Secret ä¼ é€’ï¼Œä¸ä¼šå‡ºç°åœ¨æ—¥å¿—ä¸­
# - ç”¨æˆ·æ‰‹å†ŒåŒæ­¥å‰ä¼šè¿›è¡Œæ•æ„Ÿä¿¡æ¯æ‰«æ
#
# å‰ç½®æ¡ä»¶ï¼š
# - åœ¨å…¬å¼€ä»“åº“è®¾ç½® Secrets:
#   - PRIVATE_REPO: ç§æœ‰ä»“åº“å (å¦‚ owner/repo)
#   - PRIVATE_REPO_PAT: æœ‰æƒé™è¯»å–ç§æœ‰ä»“åº“çš„ PAT (éœ€è¦ repo æƒé™)
#   - APPLE_CERTIFICATE: Apple å¼€å‘è€…è¯ä¹¦ (Base64)
#   - APPLE_CERTIFICATE_PASSWORD: è¯ä¹¦å¯†ç 
#   - APPLE_SIGNING_IDENTITY: ç­¾åèº«ä»½
#   - APPLE_ID: Apple ID
#   - APPLE_PASSWORD: App-specific password
#   - APPLE_TEAM_ID: Team ID
#   - TAURI_SIGNING_PRIVATE_KEY: Tauri æ›´æ–°ç­¾åç§é’¥
#   - TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ç­¾åç§é’¥å¯†ç 
#   - SENSITIVE_PATTERNS: æ•æ„Ÿä¿¡æ¯æ­£åˆ™æ¨¡å¼ï¼ˆå¯é€‰ï¼Œç”¨|åˆ†éš”å¤šä¸ªæ¨¡å¼ï¼‰

name: Release

on:
  repository_dispatch:
    types: [build-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 0.5.0)'
        required: true

jobs:
  # éªŒè¯å¹¶å‡†å¤‡å‘å¸ƒ
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION"
            echo "æ­£ç¡®æ ¼å¼ç¤ºä¾‹: 0.1.0, 1.0.0, 1.0.0-beta.1"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬å·: $VERSION"

      - name: æ£€å‡ºç§æœ‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: v${{ steps.version.outputs.version }}
          sparse-checkout: |
            user-guide

      - name: æå– Changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG_FILE="user-guide/en/changelog.md"

          if [ -f "$CHANGELOG_FILE" ]; then
            # æå–å½“å‰ç‰ˆæœ¬çš„ changelog å†…å®¹
            # åŒ¹é… ## [ç‰ˆæœ¬å·] åˆ°ä¸‹ä¸€ä¸ª ## æˆ–æ–‡ä»¶ç»“æŸ
            CONTENT=$(awk -v ver="$VERSION" '
              /^## \[/ {
                if (found) exit
                if (index($0, "["ver"]")) found=1
              }
              found && !/^## \[/ { print }
            ' "$CHANGELOG_FILE")

            if [ -n "$CONTENT" ]; then
              # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¤„ç†å¤šè¡Œï¼‰
              echo "$CONTENT" > /tmp/changelog.md
              echo "âœ… å·²æå– v$VERSION çš„æ›´æ–°æ—¥å¿—"
            else
              echo "âš ï¸ æœªæ‰¾åˆ° v$VERSION çš„æ›´æ–°æ—¥å¿—ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹"
              echo "é¦–æ¬¡å‘å¸ƒ" > /tmp/changelog.md
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° changelog æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹"
            echo "ç‰ˆæœ¬æ›´æ–°" > /tmp/changelog.md
          fi

          # ä½¿ç”¨ EOF å¤„ç†å¤šè¡Œå†…å®¹
          {
            echo 'content<<EOF'
            cat /tmp/changelog.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: 'MobausStudio v${{ steps.version.outputs.version }}'
          body: |
            ${{ steps.changelog.outputs.content }}

            ---

            ## ğŸ“¥ ä¸‹è½½è¯´æ˜

            | å¹³å° | æ–‡ä»¶ |
            |------|------|
            | macOS (Apple Silicon) | `.dmg` (aarch64) |
            | macOS (Intel) | `.dmg` (x86_64) |
            | Windows | `.msi` æˆ– `.exe` |
            | Linux (Debian/Ubuntu) | `.deb` |
            | Linux (Fedora/RHEL) | `.rpm` |
            | Linux (é€šç”¨) | `.AppImage` |

            ## ğŸ”„ è‡ªåŠ¨æ›´æ–°

            æ¡Œé¢åº”ç”¨å†…ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼Œå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥æ–°ç‰ˆæœ¬ã€‚
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # åŒæ­¥ç”¨æˆ·æ‰‹å†Œåˆ°å…¬å¼€ä»“åº“
  sync-docs:
    needs: [prepare-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºå…¬å¼€ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: æ£€å‡ºç§æœ‰ä»“åº“ç”¨æˆ·æ‰‹å†Œ
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: v${{ needs.prepare-release.outputs.version }}
          path: private-repo
          sparse-checkout: |
            user-guide

      - name: æ•æ„Ÿä¿¡æ¯æ‰«æ
        id: security-scan
        run: |
          echo "ğŸ” æ‰«ææ•æ„Ÿä¿¡æ¯..."

          # é»˜è®¤æ•æ„Ÿæ¨¡å¼ + è‡ªå®šä¹‰æ¨¡å¼
          DEFAULT_PATTERNS="kinzhi|PRIVATE|SECRET|API_KEY|PASSWORD|apikey|api-key"
          CUSTOM_PATTERNS="${{ secrets.SENSITIVE_PATTERNS }}"

          if [ -n "$CUSTOM_PATTERNS" ]; then
            PATTERNS="$DEFAULT_PATTERNS|$CUSTOM_PATTERNS"
          else
            PATTERNS="$DEFAULT_PATTERNS"
          fi

          # æ‰«æ user-guide ç›®å½•
          FOUND_ISSUES=""
          while IFS= read -r -d '' file; do
            if grep -iE "$PATTERNS" "$file" > /dev/null 2>&1; then
              FOUND_ISSUES="$FOUND_ISSUES\n- $file"
            fi
          done < <(find private-repo/user-guide -type f \( -name "*.md" -o -name "*.txt" -o -name "*.json" \) -print0)

          if [ -n "$FOUND_ISSUES" ]; then
            echo "âŒ å‘ç°æ•æ„Ÿä¿¡æ¯ï¼ä»¥ä¸‹æ–‡ä»¶åŒ…å«æ•æ„Ÿå†…å®¹:"
            echo -e "$FOUND_ISSUES"
            echo "è¯·æ£€æŸ¥å¹¶ç§»é™¤æ•æ„Ÿä¿¡æ¯åé‡è¯•"
            exit 1
          fi

          echo "âœ… æ•æ„Ÿä¿¡æ¯æ‰«æé€šè¿‡"

      - name: åŒæ­¥ç”¨æˆ·æ‰‹å†Œ
        run: |
          # æ¸…ç†æ—§çš„ user-guideï¼ˆä¿ç•™ .gitï¼‰
          rm -rf user-guide

          # å¤åˆ¶æ–°çš„ user-guide
          cp -r private-repo/user-guide .

          # å¤åˆ¶ README åˆ°æ ¹ç›®å½•
          if [ -f "user-guide/PUBLIC_README.md" ]; then
            cp user-guide/PUBLIC_README.md README.md
            echo "âœ… å·²æ›´æ–° README.md"
          fi

          if [ -f "user-guide/PUBLIC_README_ZH.md" ]; then
            cp user-guide/PUBLIC_README_ZH.md README_ZH.md
            echo "âœ… å·²æ›´æ–° README_ZH.md"
          fi

          # å¤åˆ¶ LICENSE
          if [ -f "user-guide/LICENSE" ]; then
            cp user-guide/LICENSE LICENSE
            echo "âœ… å·²æ›´æ–° LICENSE"
          fi

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf private-repo

          echo "âœ… ç”¨æˆ·æ‰‹å†ŒåŒæ­¥å®Œæˆ"

      - name: æäº¤æ›´æ”¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–‡æ¡£å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "docs: åŒæ­¥ç”¨æˆ·æ‰‹å†Œ v${{ needs.prepare-release.outputs.version }}"
            git push
            echo "âœ… æ–‡æ¡£å·²æäº¤"
          fi

  # æ„å»ºæ¡Œé¢åº”ç”¨
  build-desktop:
    needs: [prepare-release]
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
          - platform: 'windows-latest'
            args: ''
            target: ''
          - platform: 'ubuntu-22.04'
            args: ''
            target: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: v${{ needs.prepare-release.outputs.version }}

      - name: å‡†å¤‡æ„å»ºç¯å¢ƒ
        id: version
        shell: bash
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # é™é»˜æ›´æ–°ç‰ˆæœ¬å·
          if command -v jq &> /dev/null; then
            jq ".version = \"$VERSION\"" package.json > package.json.tmp && mv package.json.tmp package.json
            jq ".version = \"$VERSION\"" src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
          else
            sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json && rm -f package.json.bak
            sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json && rm -f src-tauri/tauri.conf.json.bak
          fi

          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf > /dev/null 2>&1
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£…ä¾èµ–
        shell: bash
        run: |
          npm ci --silent > /dev/null 2>&1
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å¯¼å…¥ç­¾åè¯ä¹¦ (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "âš ï¸ æœªé…ç½®è¯ä¹¦ï¼Œè·³è¿‡ç­¾å"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $RUNNER_TEMP/certificate.p12

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH 2>/dev/null
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH 2>/dev/null
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH 2>/dev/null
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH 2>/dev/null
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH 2>/dev/null
          security list-keychain -d user -s $KEYCHAIN_PATH 2>/dev/null

          echo "âœ… è¯ä¹¦å¯¼å…¥å®Œæˆ"

      - name: æ„å»ºåº”ç”¨
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v${{ steps.version.outputs.version }}
          releaseName: 'MobausStudio v${{ steps.version.outputs.version }}'
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  # æ„å»º Web ç‰ˆæœ¬
  build-web:
    needs: [prepare-release]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: v${{ needs.prepare-release.outputs.version }}

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: æ„å»º Web ç‰ˆæœ¬
        shell: bash
        run: |
          npm ci --silent > /dev/null 2>&1
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          npm run build > /dev/null 2>&1
          echo "âœ… Web æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…å¹¶ä¸Šä¼ 
        run: |
          cd dist && zip -rq ../MobausStudio-web.zip .
          echo "âœ… æ‰“åŒ…å®Œæˆ"

      - name: ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          files: MobausStudio-web.zip
          tag_name: v${{ needs.prepare-release.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»º Docker é•œåƒ
  build-docker:
    needs: [prepare-release]
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          ref: v${{ needs.prepare-release.outputs.version }}

      - name: è®¾ç½® Docker ç¯å¢ƒ
        run: echo "ğŸ³ é…ç½® Docker æ„å»ºç¯å¢ƒ..."

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®é•œåƒåç§°
        id: image
        run: |
          # å¼ºåˆ¶è½¬æ¢ä¸ºå°å†™
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          VERSION="${{ needs.prepare-release.outputs.version }}"
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)

          echo "name=ghcr.io/${REPO_LOWER}" >> $GITHUB_OUTPUT
          echo "major_minor=$MAJOR_MINOR" >> $GITHUB_OUTPUT

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.image.outputs.name }}:${{ needs.prepare-release.outputs.version }}
            ${{ steps.image.outputs.name }}:${{ steps.image.outputs.major_minor }}
            ${{ steps.image.outputs.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
